<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Node-RED Dashboard 2 · Thermostat Testbed</title>
    <meta name="description" content="Testbed for ui-thermostat widget in a Node-RED Dashboard 2 style layout" />

    <style>
      :root {
        --nrdb-bg: #020617;
        --nrdb-surface: #020617;
        --nrdb-card: #020617;
        --nrdb-card-alt: #020617;
        --nrdb-border-subtle: rgba(148, 163, 184, 0.25);
        --nrdb-text: #e5e7eb;
        --nrdb-text-muted: #9ca3af;
        --nrdb-accent: #38bdf8;
      }

      * {
        box-sizing: border-box;
      }

      body.nrdb-body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top left, #0b1120 0, #020617 45%, #000 100%);
        color: var(--nrdb-text);
        display: flex;
        align-items: stretch;
        justify-content: center;
      }

      .nrdb-app {
        flex: 1;
        max-width: 1200px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .nrdb-header {
        font-size: 14px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--nrdb-text-muted);
        border-bottom: 1px solid var(--nrdb-border-subtle);
        padding-bottom: 8px;
      }

      .nrdb-main {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      /* Node-RED Dashboard 2 style layout scaffolding */

      .nrdb-ui-page {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(6, minmax(0, 1fr));
        grid-auto-rows: minmax(0, 1fr);
        gap: 16px;
      }

      /* Single group centered like a typical dashboard card */
      .nrdb-ui-page--single {
        align-items: center;
        justify-items: center;
      }

      .nrdb-ui-page--single > .nrdb-ui-group {
        grid-column: span 3;
        max-width: 420px;
        width: 100%;
      }

      .nrdb-ui-group.v-card {
        background: radial-gradient(circle at top, #020617 0, #020617 100%);
        border-radius: 18px;
        border: 1px solid var(--nrdb-border-subtle);
        box-shadow:
          0 24px 60px rgba(0, 0, 0, 0.7),
          0 0 0 1px rgba(15, 23, 42, 0.9);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .nrdb-ui-group-header.v-card-title {
        padding: 10px 16px 8px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.9);
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 8px;
      }

      .nrdb-ui-group-title {
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--nrdb-text);
      }

      .nrdb-ui-group-subtitle {
        font-size: 12px;
        color: var(--nrdb-text-muted);
        white-space: nowrap;
      }

      .nrdb-ui-group-body.v-card-text {
        padding: 12px 12px 16px;
      }

      .nrdb-ui-widget.v-card.nrdb-ui-widget--thermostat {
        background: radial-gradient(circle at top, #020617 0, #020617 100%);
        border-radius: 16px;
        border: 1px solid rgba(15, 23, 42, 0.9);
        box-shadow:
          0 16px 40px rgba(0, 0, 0, 0.6),
          inset 0 0 0 1px rgba(15, 23, 42, 0.8);
      }

      .nrdb-ui-widget-body.v-card-text {
        padding: 12px;
      }

      .nrdb-ui-widget-content {
        width: 100%;
        /* Mimic a 2x2 tile in the dashboard grid */
        max-width: 320px;
        margin: 0 auto;
        aspect-ratio: 1 / 1;
      }

      .nrdb-footer-hint {
        margin-top: 8px;
        font-size: 11px;
        color: var(--nrdb-text-muted);
      }

      .nrdb-footer-hint code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        background: rgba(15, 23, 42, 0.9);
        padding: 2px 5px;
        border-radius: 4px;
      }

      .nrdb-error {
        font-size: 13px;
        color: #fecaca;
        padding: 12px;
        text-align: center;
      }

      @media (max-width: 768px) {
        .nrdb-ui-page {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .nrdb-ui-page--single > .nrdb-ui-group {
          grid-column: 1 / -1;
        }
      }
    </style>
  </head>
  <body class="nrdb-body">
    <div id="app" class="nrdb-app">
      <header class="nrdb-header">
        Node-RED Dashboard 2 · Thermostat widget testbed
      </header>

      <main class="nrdb-main">
        <section class="nrdb-ui-page nrdb-ui-page--single">
          <div class="nrdb-ui-group v-card">
            <div class="nrdb-ui-group-header v-card-title">
              <div class="nrdb-ui-group-title">Climate</div>
              <div class="nrdb-ui-group-subtitle">Living room · 2×2 widget</div>
            </div>

            <div class="nrdb-ui-group-body v-card-text">
              <div class="nrdb-ui-widget v-card nrdb-ui-widget--thermostat">
                <div class="nrdb-ui-widget-body v-card-text">
                  <!-- This is where the Vue widget mounts -->
                  <div id="thermostat-widget" class="nrdb-ui-widget-content"></div>
                </div>
              </div>

              <div class="nrdb-footer-hint">
                Using real <code>UIThermostat</code> from <code>ui-thermostat.umd.js</code>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Vue 3 + Vuex 4 globals (match UMD expectations: window.Vue, window.vuex) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/vuex@4/dist/vuex.global.prod.js"></script>

    <!-- Built widget bundle from this repo -->
    <script src="./resources/ui-thermostat.umd.js"></script>

    <script>
      (function () {
        // Vue 3 global build exposes window.Vue
        const { createApp, h } = window.Vue || {};

        // Vuex 4 global build typically exposes window.Vuex
        // The UMD bundle expects a global named `vuex`, so alias it if needed.
        if (!window.vuex && window.Vuex) {
          window.vuex = window.Vuex;
        }
        const { createStore } = (window.vuex || window.Vuex || {});

        if (!createApp || !createStore) {
          console.error('Vue 3 or Vuex 4 not found on window');
          const mountEl = document.getElementById('thermostat-widget');
          if (mountEl) {
            mountEl.innerText = 'Vue 3 / Vuex 4 could not be loaded.';
          }
          return;
        }

        // Minimal Node-RED Dashboard 2 style store:
        //   - data/messages module
        //   - updateMessage mutation
        const store = createStore({
          modules: {
            data: {
              namespaced: true,
              state: () => ({
                messages: {}
              }),
              mutations: {
                updateMessage (state, { id, msg }) {
                  state.messages = {
                    ...state.messages,
                    [id]: msg
                  };
                }
              }
            }
          }
        });

        // Very small $socket mock – logs widget actions
        const socketMock = {
          emit (event, payload) {
            // This matches how Node-RED Dashboard 2 widgets talk back to runtime
            console.log('[widget-action]', event, payload);
          }
        };

        // Very small $dataTracker mock – just calls onLoad immediately
        function dataTrackerMock (id, onInput, onLoad) {
          console.log('[dataTracker] register widget', id);

          if (typeof onLoad === 'function') {
            try {
              onLoad();
            } catch (err) {
              console.warn('[dataTracker:onLoad] error', err);
            }
          }

          // Return simple unregister callback
          return function unregister () {
            console.log('[dataTracker] unregister widget', id);
          };
        }

        const ThermostatComponent = (window['ui-thermostat'] || {}).UIThermostat;

        const Root = {
          name: 'ThermostatMount',
          render () {
            if (!ThermostatComponent) {
              return h(
                'div',
                { class: 'nrdb-error' },
                'UIThermostat component not available from ui-thermostat.umd.js'
              );
            }

            return h(ThermostatComponent, {
              id: 'thermostat-1',
              props: {},
              state: { enabled: true, visible: true }
            });
          }
        };

        const app = createApp(Root);

        app.use(store);
        app.provide('$socket', socketMock);
        app.provide('$dataTracker', dataTrackerMock);

        app.mount('#thermostat-widget');

        // Seed an initial message payload so the widget has data to render
        store.commit('data/updateMessage', {
          id: 'thermostat-1',
          msg: {
            payload: {
              currentTemp: 21.3,
              targetTemp: 22.5,
              heatingPercent: 40
            }
          }
        });
      })();
    </script>
  </body>
</html>
